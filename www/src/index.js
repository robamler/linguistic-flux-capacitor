import './styles.css';

// Wasm modules must be imported asynchronously.
import("./backend.js");

(async function () {
    const Plotter = await import('./plotting/main.mjs');
    if (document.readyState === 'loading') {
        await new Promise(function (resolve, _reject) {
            window.addEventListener('DOMContentLoaded', resolve);
        });
    }

    let years = [];
    let pointsY1 = [];
    let pointsY2 = [];
    let ticksX = [];
    for (let year = 1800; year <= 2008; year += 1) {
        years.push(year);
        if (year % 20 === 0) {
            ticksX.push(year);
        }

        pointsY1.push(0.3 * Math.sin(0.1 * year));
        pointsY2.push(0.2 * Math.sin(0.2 * year) + 0.002 * (year - 1900));
    }

    const mainPlot = Plotter.createPlot(
        document.getElementById('mainPlot'), years, ticksX, updateTooltip);

    let trajectories = [
        {
            mainWord: 'broadcast',
            otherWord: 'radio',
            colorIndex: 0,
            values: [17846, 17901, 17999, 18070, 18191, 18178, 18171, 18247, 18120, 18112, 18074, 17998, 18159, 18229, 18295, 18382, 18463, 18484, 18483, 18523, 18563, 18617, 18593, 18668, 18639, 18624, 18594, 18588, 18684, 18631, 18763, 18633, 18606, 18589, 18408, 18473, 18543, 18603, 18610, 18433, 18364, 18248, 18367, 18525, 18683, 18442, 18358, 18424, 18522, 18404, 18427, 18522, 18591, 18539, 18448, 18439, 18505, 18519, 18464, 18450, 18685, 18545, 18545, 18533, 18766, 18523, 18792, 18768, 18587, 18688, 18705, 18789, 18690, 18583, 18676, 18650, 18607, 18553, 18418, 18204, 18226, 18100, 17971, 18014, 17735, 17729, 17414, 17243, 17323, 17154, 16970, 16665, 16831, 16407, 16108, 16016, 15886, 15503, 15295, 15288, 15057, 15047, 14697, 14706, 14610, 14728, 14748, 14899, 15217, 15324, 15672, 15983, 15959, 16368, 16756, 17245, 17683, 18245, 18599, 19381, 19602, 20299, 21084, 21779, 22582, 23438, 24167, 24690, 25526, 26208, 27138, 27778, 28375, 29041, 29776, 30213, 30810, 31373, 31632, 32214, 32529, 32825, 32997, 33336, 33548, 33673, 33965, 33954, 34295, 34304, 34467, 34755, 34805, 35017, 35165, 35346, 35298, 35281, 35488, 35686, 35543, 35957, 36046, 36369, 36313, 36599, 36833, 36970, 37288, 37430, 38015, 38276, 38632, 38925, 39381, 39575, 39917, 40167, 40332, 40585, 40598, 41036, 41171, 41289, 41342, 41436, 41667, 41712, 42072, 42211, 42311, 42380, 42487, 42901, 43039, 43334, 43245, 43509, 43709, 44015, 44158, 44206, 44460, 44584, 44749, 44921, 44886, 44653, 44669]
        },
        {
            mainWord: 'broadcast',
            otherWord: 'television',
            colorIndex: 1,
            values: [13734, 13707, 13844, 13861, 13902, 13754, 13773, 13771, 13768, 13858, 13888, 13915, 14028, 14033, 14148, 14334, 14415, 14477, 14427, 14498, 14549, 14472, 14545, 14565, 14577, 14567, 14555, 14530, 14703, 14771, 14891, 14843, 14799, 14863, 14771, 14794, 14965, 14967, 15089, 14903, 15109, 15020, 14957, 15129, 15284, 15212, 15322, 15252, 15342, 15333, 15376, 15467, 15591, 15742, 15708, 15727, 15919, 15931, 15994, 16077, 16153, 16248, 16189, 16394, 16730, 16600, 16803, 17058, 16965, 17105, 17180, 17227, 17292, 17571, 17576, 17645, 17754, 17797, 18031, 18157, 18031, 18196, 18332, 18465, 18528, 18632, 18661, 18832, 18642, 18888, 19033, 18909, 19188, 19252, 19177, 19034, 19189, 19199, 19274, 19533, 19480, 19545, 19603, 19495, 19865, 20012, 19989, 20199, 20518, 20404, 20483, 20925, 21099, 21175, 21288, 21355, 21546, 21647, 21984, 22053, 22223, 22419, 22441, 22625, 22970, 23081, 23258, 23431, 23719, 23931, 24100, 24457, 24537, 24938, 25460, 25460, 25640, 26195, 26330, 26583, 26951, 27039, 27284, 27591, 27907, 28126, 28265, 28593, 28956, 29215, 29389, 29511, 29719, 29854, 30143, 30310, 30556, 30658, 30858, 31080, 31339, 31546, 31739, 31967, 32047, 32353, 32692, 32907, 33352, 33423, 33910, 34384, 34566, 34875, 35342, 35578, 35944, 35951, 36447, 36576, 36675, 36912, 37192, 37255, 37394, 37596, 37759, 38049, 38338, 38585, 38729, 38807, 39089, 39426, 39831, 40145, 40384, 40770, 40966, 41144, 41553, 41683, 42032, 42152, 42486, 42634, 43050, 42974, 43081]
        },
        {
            mainWord: 'broadcast',
            otherWord: 'harvested',
            colorIndex: 2,
            values: [32763, 32738, 32762, 32817, 32867, 32921, 32963, 32888, 32886, 32891, 32832, 32863, 32833, 32894, 32883, 33023, 33000, 33062, 33072, 33081, 33057, 33036, 33037, 33102, 33151, 32939, 32935, 33016, 33079, 32924, 32954, 32925, 32886, 32874, 32882, 32960, 32854, 32879, 32866, 32833, 32764, 32694, 32607, 32466, 32547, 32696, 32513, 32444, 32294, 32144, 32135, 31991, 31754, 31900, 31650, 31585, 31343, 31306, 31318, 31311, 31464, 31348, 31414, 31538, 31529, 31455, 31624, 31717, 31783, 31787, 31850, 32054, 32087, 32085, 32093, 31990, 31854, 31790, 31830, 31698, 31569, 31445, 31380, 31406, 31362, 31414, 31341, 31409, 31354, 31064, 30930, 30944, 30913, 30702, 30185, 30378, 30340, 30052, 30008, 30016, 29785, 29833, 29693, 29534, 29501, 29525, 29419, 29322, 29262, 29018, 29072, 28952, 28637, 28633, 28251, 28321, 27812, 27556, 27364, 27240, 26789, 26422, 26157, 25938, 25402, 24925, 24625, 23833, 23437, 23002, 22366, 21861, 21263, 20728, 19962, 19488, 18887, 18240, 17685, 17059, 16692, 16302, 15956, 15493, 15286, 15105, 14823, 14724, 14492, 14471, 14219, 14086, 13800, 13780, 13747, 13502, 13443, 13148, 13068, 13178, 13080, 13119, 12933, 12639, 12531, 12397, 12448, 12074, 11810, 11717, 12012, 11482, 11232, 11337, 10989, 10970, 10741, 10718, 10526, 10313, 10172, 10152, 10090, 9892, 9705, 9933, 9782, 9809, 9691, 9559, 9611, 9578, 9657, 9524, 9378, 9676, 9696, 9642, 9630, 9847, 9965, 10035, 10066, 10137, 10504, 11030, 11325, 11760, 12487]
        },
        {
            mainWord: 'broadcast',
            otherWord: 'propagated',
            colorIndex: 3,
            values: [34320, 34320, 34729, 34921, 34677, 34410, 34461, 34387, 34304, 34333, 34257, 34262, 34227, 34633, 34856, 34979, 35277, 35460, 35559, 35817, 35738, 36189, 36493, 36409, 36649, 36597, 36717, 37007, 37168, 37343, 37597, 37558, 37655, 37797, 37829, 37975, 38054, 38155, 38266, 38425, 38315, 38266, 38411, 38573, 38743, 38663, 38759, 38705, 38704, 38643, 38867, 38743, 38678, 38807, 38631, 38588, 38599, 38424, 38542, 38445, 38487, 38176, 38230, 38210, 38401, 38007, 38166, 37994, 37734, 37709, 37592, 37570, 37597, 37402, 37369, 37353, 37255, 37045, 36910, 37005, 36884, 36736, 36660, 36719, 36576, 36531, 36455, 36384, 36359, 36323, 36107, 35998, 36046, 35859, 35620, 35720, 35704, 35445, 35407, 35460, 35326, 35361, 35323, 35188, 34939, 34988, 34960, 34843, 34593, 34520, 34508, 34363, 34180, 34215, 33945, 33753, 33356, 33245, 33115, 32853, 32315, 32222, 31805, 31281, 30810, 30704, 30325, 29649, 29287, 28564, 28081, 27437, 26745, 26104, 25348, 24818, 24153, 23335, 22726, 21963, 21582, 21078, 20488, 19823, 19684, 19507, 19047, 18995, 18901, 18686, 18573, 18328, 18068, 18065, 18082, 18011, 17883, 17583, 17473, 17313, 17116, 17034, 16943, 16746, 16693, 16337, 16238, 16175, 15897, 16086, 16230, 15912, 15804, 15888, 15818, 15788, 15734, 15733, 15757, 15739, 15721, 15901, 15968, 15973, 15769, 16123, 16166, 16314, 16425, 16729, 16655, 16759, 16974, 16876, 16873, 17188, 17099, 17145, 17128, 17402, 17522, 17552, 17514, 17707, 17538, 17876, 17801, 18083, 18275]
        },
        {
            mainWord: 'broadcast',
            otherWord: 'strewn',
            colorIndex: 4,
            values: [31606, 31661, 31620, 31546, 31565, 31714, 31738, 31766, 31702, 31794, 31801, 31721, 31645, 31795, 31951, 31889, 31919, 31873, 31992, 32064, 32026, 32170, 32158, 32122, 32099, 32113, 32077, 32280, 32321, 32226, 32324, 32475, 32590, 32740, 32739, 32831, 32830, 32856, 33071, 33043, 33280, 33541, 33568, 33596, 33647, 33782, 34154, 34139, 34280, 34381, 34540, 34747, 34765, 35098, 35147, 35427, 35481, 35827, 35705, 35679, 36180, 36296, 36222, 36274, 36622, 36483, 36581, 36647, 36532, 36763, 36943, 37074, 37175, 37316, 37371, 37514, 37460, 37287, 37461, 37386, 37397, 37216, 37068, 37180, 37243, 37188, 36922, 36940, 36954, 36897, 36661, 36563, 36625, 36481, 36197, 36014, 35916, 35759, 35696, 35537, 35385, 35219, 34892, 34846, 34524, 34183, 33952, 33784, 33604, 33207, 33178, 32761, 32458, 32235, 31855, 31481, 31148, 30936, 30540, 30132, 29538, 29233, 28800, 28255, 27779, 27253, 26729, 26078, 25468, 24956, 24015, 23491, 22746, 22017, 21221, 20588, 20053, 19359, 18515, 17894, 17145, 16756, 16156, 15526, 15295, 15074, 14648, 14590, 14408, 14297, 14016, 13918, 13757, 13804, 13938, 13826, 13495, 13429, 13377, 13341, 13172, 13225, 13167, 13004, 12972, 12685, 12741, 12484, 12330, 12193, 12194, 12211, 11945, 11891, 11956, 12017, 12033, 12152, 12120, 12016, 12258, 12389, 12494, 12659, 12555, 12735, 12877, 13255, 13384, 13379, 13606, 13705, 13867, 14071, 14147, 14568, 14642, 14750, 14907, 15053, 15063, 15293, 15492, 15466, 15727, 16121, 16424, 16607, 17037]
        },
        {
            mainWord: 'broadcast',
            otherWord: 'sowing',
            colorIndex: 5,
            values: [33203, 33176, 33441, 33547, 33696, 33717, 33635, 33565, 33452, 33528, 33442, 33457, 33610, 33774, 33564, 33628, 33550, 33644, 33805, 33737, 33871, 33892, 33939, 34138, 34099, 34017, 34006, 34226, 34031, 34003, 33903, 34024, 34117, 34254, 34210, 34320, 34275, 34150, 34215, 34174, 34204, 34254, 33948, 33953, 33869, 34079, 34182, 33927, 33764, 33784, 33872, 33903, 33623, 33650, 33572, 33537, 33526, 33525, 33584, 33575, 33714, 33481, 33453, 33463, 33569, 33413, 33370, 33316, 33154, 33241, 33211, 33273, 33176, 33157, 33100, 32986, 33182, 33029, 32774, 32753, 32742, 32802, 32555, 32389, 32412, 32144, 32144, 32067, 31925, 31649, 31600, 31478, 31491, 31226, 30909, 30616, 30509, 30464, 30234, 30130, 29973, 29874, 29652, 29546, 29393, 29220, 29006, 28945, 28808, 28665, 28496, 28157, 27814, 27837, 27282, 27316, 26916, 26609, 26166, 25856, 25342, 25047, 24537, 23981, 23695, 23134, 22638, 22005, 21495, 21065, 20250, 19728, 18958, 18525, 18057, 17565, 16967, 16371, 15870, 15298, 14911, 14457, 14155, 13454, 13512, 13403, 13070, 13070, 12751, 12752, 12305, 12352, 12021, 11982, 11778, 11612, 11550, 11520, 11273, 11131, 10977, 10793, 10636, 10322, 10010, 9765, 9737, 9590, 9237, 9231, 9244, 8971, 8732, 8911, 8455, 8500, 8625, 8598, 8609, 8365, 8388, 8371, 8189, 8419, 8111, 8201, 8103, 8096, 8158, 7954, 7801, 7591, 7399, 7277, 7355, 7592, 7475, 7323, 7065, 7162, 7275, 7165, 7153, 7205, 7362, 7693, 7757, 8299, 8885]
        },
    ];
    let scale_square = 1.68336e-05;

    for (let trajectory of trajectories) {
        let { mainWord, otherWord, colorIndex, values } = trajectory;
        for (let i = 0; i < values.length; i += 1) {
            values[i] *= scale_square;
        }
        mainPlot.plotLine(
            values,
            colorIndex,
            0,
            {
                mainWord,
                description: mainWord + ' : ' + otherWord
            }
        );
    }

    let suggestions = document.getElementsByClassName('suggestion');
    for (let i = 0; i < suggestions.length; i += 1) {
        suggestions[i].addEventListener('click', e => {
            e.target.classList.toggle('active');
        });
    }

    function updateTooltip(tooltip, line, indexX) {
        tooltip.classList.add('waiting');
        tooltip.querySelector('.year').innerText = years[indexX];
        tooltip.querySelector('.lineDescription').innerText = line.payload.description;
        tooltip.querySelector('.mainWord').innerText = line.payload.mainWord;

        // TODO: defer (setTimeout(..., 0)) calculation of nearest neighbors;
        // when done and not canceled, write them to tooltip.
        // (Unless results are cached, in which case we immediately display
        // them without setting a timeout.)
    }
}())
